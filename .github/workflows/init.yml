name: init

on:
  workflow_call:
    inputs:
      tag:
        required: true
        type: string
      arch:
        required: true
        type: string

jobs:
  docker:
    runs-on: ubuntu-latest
    steps:
    # Restore cache
    - id: cache-docker
      uses: actions/cache@v4
      with:
        path: ${{ runner.temp }}/recalbox-${{ inputs.tag }}-${{ inputs.arch }}.tar.zst
        key: recalbox-${{ inputs.tag }}-${{ inputs.arch }}.tar.zst
    # Build Docker image
    - if: steps.cache-docker.outputs.cache-hit != 'true'
      run: |
        git clone --depth 1 --branch "${{ inputs.tag }}" https://gitlab.com/recalbox/recalbox.git "${{ github.workspace }}/recalbox"
        docker build --tag recalbox "${{ github.workspace }}/recalbox"
        docker save recalbox | zstd -o "${{ runner.temp }}/recalbox-${{ inputs.tag }}-${{ inputs.arch }}.tar.zst"
    - uses: actions/upload-artifact@v4
      with:
        name: recalbox-${{ inputs.tag }}-${{ inputs.arch }}.tar.zst
        path: ${{ runner.temp }}/recalbox-${{ inputs.tag }}-${{ inputs.arch }}.tar.zst
  work:
    runs-on: ubuntu-latest
    steps:
    # Install dependencies
    - run: |
        sudo apt update
        sudo apt install --yes zfsutils-linux qemu-utils
    - run: |
        set -x
        sudo modprobe nbd nbds_max=1
        qemu-img create -f qcow2 "${{ runner.temp }}/work-${{ inputs.tag }}-${{ inputs.arch }}.zpool.qcow2" 64G
        sudo qemu-nbd --connect /dev/nbd0 --format qcow2 "${{ runner.temp }}/work-${{ inputs.tag }}-${{ inputs.arch }}.zpool.qcow2"
        sudo zpool create -O compression=zstd -m /pool/work work /dev/nbd0
        sudo chown "$USER:$USER" /pool/work/
    # Clone repo
    - run: |
        git clone --depth 1 --shallow-submodules --recurse-submodules --branch "${{ inputs.tag }}" https://gitlab.com/recalbox/recalbox.git "/pool/work/recalbox/"
    # Apply patch
    - uses: actions/checkout@v6
    - run: |
        set -x
        cd "/pool/work/recalbox/"
        set +e
        git apply "${{ github.workspace }}/patch/bass24.patch"
        git apply "${{ github.workspace }}/patch/megatools.patch"
        git apply "${{ github.workspace }}/patch/libretro-melonds.patch"
        git apply "${{ github.workspace }}/patch/libretro-tamalibretro.patch"
        git apply "${{ github.workspace }}/patch/docker-ccache.patch"
    # Export zpool
    - run: |
        zfs get all work
        sudo zpool export work
        sudo qemu-nbd --disconnect /dev/nbd0
    - uses: actions/upload-artifact@v4
      with:
        name: work-${{ inputs.tag }}-${{ inputs.arch }}.zpool.qcow2
        path: ${{ runner.temp }}/work-${{ inputs.tag }}-${{ inputs.arch }}.zpool.qcow2
        compression-level: 0
  dl:
    runs-on: ubuntu-latest
    steps:
    # Install dependencies
    - run: |
        sudo apt update
        sudo apt install --yes zfsutils-linux qemu-utils
    - run: |
        set -x
        sudo modprobe nbd nbds_max=1
        qemu-img create -f qcow2 "${{ runner.temp }}/dl-${{ inputs.tag }}-${{ inputs.arch }}.zpool.qcow2" 64G
        sudo qemu-nbd --connect /dev/nbd0 --format qcow2 "${{ runner.temp }}/dl-${{ inputs.tag }}-${{ inputs.arch }}.zpool.qcow2"
        sudo zpool create -O compression=zstd -m /pool/dl dl /dev/nbd0
        sudo chown "$USER:$USER" /pool/dl/
        ln -s /pool/ftp/ /pool/dl/acl
        ln -s /pool/ftp/ /pool/dl/alsa-lib
        ln -s /pool/ftp/ /pool/dl/alsa-plugins
        ln -s /pool/ftp/ /pool/dl/alsa-utils
        ln -s /pool/ftp/ /pool/dl/attr
        ln -s /pool/ftp/ /pool/dl/autoconf
        ln -s /pool/ftp/ /pool/dl/autoconf-archive
        ln -s /pool/ftp/ /pool/dl/automake
        ln -s /pool/ftp/ /pool/dl/avahi
        ln -s /pool/ftp/ /pool/dl/bash
        ln -s /pool/ftp/ /pool/dl/bcm2835
        ln -s /pool/ftp/ /pool/dl/bento4
        ln -s /pool/ftp/ /pool/dl/binutils
        ln -s /pool/ftp/ /pool/dl/bison
        ln -s /pool/ftp/ /pool/dl/bluez5_utils
        ln -s /pool/ftp/ /pool/dl/boost
        ln -s /pool/ftp/ /pool/dl/brcmfmac_sdio-firmware-rpi
        ln -s /pool/ftp/ /pool/dl/busybox
        ln -s /pool/ftp/ /pool/dl/bzip2
        ln -s /pool/ftp/ /pool/dl/ca-certificates
        ln -s /pool/ftp/ /pool/dl/cairo
        ln -s /pool/ftp/ /pool/dl/cifs-utils
        ln -s /pool/ftp/ /pool/dl/clang
        ln -s /pool/ftp/ /pool/dl/cmake
        ln -s /pool/ftp/ /pool/dl/cmocka
        ln -s /pool/ftp/ /pool/dl/crda
        ln -s /pool/ftp/ /pool/dl/dav1d
        ln -s /pool/ftp/ /pool/dl/dbus
        ln -s /pool/ftp/ /pool/dl/dbus-cpp
        ln -s /pool/ftp/ /pool/dl/dbus-python
        ln -s /pool/ftp/ /pool/dl/dejavu
        ln -s /pool/ftp/ /pool/dl/dhcpcd
        ln -s /pool/ftp/ /pool/dl/diffutils
        ln -s /pool/ftp/ /pool/dl/dos2unix
        ln -s /pool/ftp/ /pool/dl/dosfstools
        ln -s /pool/ftp/ /pool/dl/double-conversion
        ln -s /pool/ftp/ /pool/dl/dropbear
        ln -s /pool/ftp/ /pool/dl/dtc
        ln -s /pool/ftp/ /pool/dl/e2fsprogs
        ln -s /pool/ftp/ /pool/dl/elfutils
        ln -s /pool/ftp/ /pool/dl/eudev
        ln -s /pool/ftp/ /pool/dl/evtest
        ln -s /pool/ftp/ /pool/dl/exfat
        ln -s /pool/ftp/ /pool/dl/exfat-utils
        ln -s /pool/ftp/ /pool/dl/expat
        ln -s /pool/ftp/ /pool/dl/expect
        ln -s /pool/ftp/ /pool/dl/faad2
        ln -s /pool/ftp/ /pool/dl/fakeroot
        ln -s /pool/ftp/ /pool/dl/fbdump
        ln -s /pool/ftp/ /pool/dl/fbgrab
        ln -s /pool/ftp/ /pool/dl/ffmpeg
        ln -s /pool/ftp/ /pool/dl/flac
        ln -s /pool/ftp/ /pool/dl/flatbuffers
        ln -s /pool/ftp/ /pool/dl/flex
        ln -s /pool/ftp/ /pool/dl/fluidsynth
        ln -s /pool/ftp/ /pool/dl/fmt
        ln -s /pool/ftp/ /pool/dl/fontconfig
        ln -s /pool/ftp/ /pool/dl/freetype
        ln -s /pool/ftp/ /pool/dl/fstrcmp
        ln -s /pool/ftp/ /pool/dl/gawk
        ln -s /pool/ftp/ /pool/dl/gcc
        ln -s /pool/ftp/ /pool/dl/genimage
        ln -s /pool/ftp/ /pool/dl/gesftpserver
        ln -s /pool/ftp/ /pool/dl/gettext-tiny
        ln -s /pool/ftp/ /pool/dl/giflib
        ln -s /pool/ftp/ /pool/dl/glibc
        ln -s /pool/ftp/ /pool/dl/glm
        ln -s /pool/ftp/ /pool/dl/gmp
        ln -s /pool/ftp/ /pool/dl/gnutls
        ln -s /pool/ftp/ /pool/dl/gobject-introspection
        ln -s /pool/ftp/ /pool/dl/gperf
        ln -s /pool/ftp/ /pool/dl/harfbuzz
        ln -s /pool/ftp/ /pool/dl/heimdal
        ln -s /pool/ftp/ /pool/dl/hicolor-icon-theme
        ln -s /pool/ftp/ /pool/dl/hidapi
        ln -s /pool/ftp/ /pool/dl/htop
        ln -s /pool/ftp/ /pool/dl/hwdata
        ln -s /pool/ftp/ /pool/dl/i2c-tools
        ln -s /pool/ftp/ /pool/dl/icu
        ln -s /pool/ftp/ /pool/dl/isl
        ln -s /pool/ftp/ /pool/dl/iw
        ln -s /pool/ftp/ /pool/dl/jimtcl
        ln -s /pool/ftp/ /pool/dl/jpeg-turbo
        ln -s /pool/ftp/ /pool/dl/jsoncpp
        ln -s /pool/ftp/ /pool/dl/json-for-modern-cpp
        ln -s /pool/ftp/ /pool/dl/kbd
        ln -s /pool/ftp/ /pool/dl/kmod
        ln -s /pool/ftp/ /pool/dl/kodi
        ln -s /pool/ftp/ /pool/dl/kodi-audiodecoder-modplug
        ln -s /pool/ftp/ /pool/dl/kodi-audiodecoder-nosefart
        ln -s /pool/ftp/ /pool/dl/kodi-audiodecoder-sidplay
        ln -s /pool/ftp/ /pool/dl/kodi-audiodecoder-snesapu
        ln -s /pool/ftp/ /pool/dl/kodi-audiodecoder-stsound
        ln -s /pool/ftp/ /pool/dl/kodi-audiodecoder-timidity
        ln -s /pool/ftp/ /pool/dl/kodi-audiodecoder-vgmstream
        ln -s /pool/ftp/ /pool/dl/kodi-audioencoder-flac
        ln -s /pool/ftp/ /pool/dl/kodi-audioencoder-lame
        ln -s /pool/ftp/ /pool/dl/kodi-audioencoder-vorbis
        ln -s /pool/ftp/ /pool/dl/kodi-audioencoder-wav
        ln -s /pool/ftp/ /pool/dl/kodi-inputstream-adaptive
        ln -s /pool/ftp/ /pool/dl/kodi-inputstream-ffmpegdirect
        ln -s /pool/ftp/ /pool/dl/kodi-inputstream-rtmp
        ln -s /pool/ftp/ /pool/dl/kodi-peripheral-joystick
        ln -s /pool/ftp/ /pool/dl/kodi-peripheral-xarcade
        ln -s /pool/ftp/ /pool/dl/kodi-pvr-argustv
        ln -s /pool/ftp/ /pool/dl/kodi-pvr-dvblink
        ln -s /pool/ftp/ /pool/dl/kodi-pvr-dvbviewer
        ln -s /pool/ftp/ /pool/dl/kodi-pvr-filmon
        ln -s /pool/ftp/ /pool/dl/kodi-pvr-hdhomerun
        ln -s /pool/ftp/ /pool/dl/kodi-pvr-hts
        ln -s /pool/ftp/ /pool/dl/kodi-pvr-iptvsimple
        ln -s /pool/ftp/ /pool/dl/kodi-pvr-mediaportal-tvserver
        ln -s /pool/ftp/ /pool/dl/kodi-pvr-mythtv
        ln -s /pool/ftp/ /pool/dl/kodi-pvr-nextpvr
        ln -s /pool/ftp/ /pool/dl/kodi-pvr-njoy
        ln -s /pool/ftp/ /pool/dl/kodi-pvr-octonet
        ln -s /pool/ftp/ /pool/dl/kodi-pvr-pctv
        ln -s /pool/ftp/ /pool/dl/kodi-pvr-plutotv
        ln -s /pool/ftp/ /pool/dl/kodi-pvr-stalker
        ln -s /pool/ftp/ /pool/dl/kodi-pvr-vbox
        ln -s /pool/ftp/ /pool/dl/kodi-pvr-vdr-vnsi
        ln -s /pool/ftp/ /pool/dl/kodi-pvr-vuplus
        ln -s /pool/ftp/ /pool/dl/kodi-pvr-waipu
        ln -s /pool/ftp/ /pool/dl/kodi-pvr-wmc
        ln -s /pool/ftp/ /pool/dl/kodi-pvr-zattoo
        ln -s /pool/ftp/ /pool/dl/lame
        ln -s /pool/ftp/ /pool/dl/lcms2
        ln -s /pool/ftp/ /pool/dl/libaio
        ln -s /pool/ftp/ /pool/dl/libao
        ln -s /pool/ftp/ /pool/dl/libass
        ln -s /pool/ftp/ /pool/dl/libb2
        ln -s /pool/ftp/ /pool/dl/libcdio
        ln -s /pool/ftp/ /pool/dl/libcec
        ln -s /pool/ftp/ /pool/dl/libconfuse
        ln -s /pool/ftp/ /pool/dl/libcrossguid
        ln -s /pool/ftp/ /pool/dl/libcurl
        ln -s /pool/ftp/ /pool/dl/libdaemon
        ln -s /pool/ftp/ /pool/dl/libdisplay-info
        ln -s /pool/ftp/ /pool/dl/libdrm
        ln -s /pool/ftp/ /pool/dl/libepoxy
        ln -s /pool/ftp/ /pool/dl/libevdev
        ln -s /pool/ftp/ /pool/dl/libevent
        ln -s /pool/ftp/ /pool/dl/libffi
        ln -s /pool/ftp/ /pool/dl/libfreeimage
        ln -s /pool/ftp/ /pool/dl/libfribidi
        ln -s /pool/ftp/ /pool/dl/libfuse3
        ln -s /pool/ftp/ /pool/dl/libgcrypt
        ln -s /pool/ftp/ /pool/dl/libglew
        ln -s /pool/ftp/ /pool/dl/libglib2
        ln -s /pool/ftp/ /pool/dl/libglu
        ln -s /pool/ftp/ /pool/dl/libgpg-error
        ln -s /pool/ftp/ /pool/dl/libgudev
        ln -s /pool/ftp/ /pool/dl/libhdhomerun
        ln -s /pool/ftp/ /pool/dl/libidn
        ln -s /pool/ftp/ /pool/dl/libinput
        ln -s /pool/ftp/ /pool/dl/libjpeg
        ln -s /pool/ftp/ /pool/dl/liblockfile
        ln -s /pool/ftp/ /pool/dl/libmad
        ln -s /pool/ftp/ /pool/dl/libmicrohttpd
        ln -s /pool/ftp/ /pool/dl/libmodplug
        ln -s /pool/ftp/ /pool/dl/libmpeg2
        ln -s /pool/ftp/ /pool/dl/libnfs
        ln -s /pool/ftp/ /pool/dl/libnl
        ln -s /pool/ftp/ /pool/dl/libnspr
        ln -s /pool/ftp/ /pool/dl/libnss
        ln -s /pool/ftp/ /pool/dl/libogg
        ln -s /pool/ftp/ /pool/dl/libopenssl
        ln -s /pool/ftp/ /pool/dl/libpcap
        ln -s /pool/ftp/ /pool/dl/libplatform
        ln -s /pool/ftp/ /pool/dl/libplist
        ln -s /pool/ftp/ /pool/dl/libpng
        ln -s /pool/ftp/ /pool/dl/libpthread-stubs
        ln -s /pool/ftp/ /pool/dl/libserialport
        ln -s /pool/ftp/ /pool/dl/libshairplay
        ln -s /pool/ftp/ /pool/dl/libsidplay2
        ln -s /pool/ftp/ /pool/dl/libsndfile
        ln -s /pool/ftp/ /pool/dl/libtasn1
        ln -s /pool/ftp/ /pool/dl/libtheora
        ln -s /pool/ftp/ /pool/dl/libtirpc
        ln -s /pool/ftp/ /pool/dl/libtool
        ln -s /pool/ftp/ /pool/dl/libunistring
        ln -s /pool/ftp/ /pool/dl/libusb
        ln -s /pool/ftp/ /pool/dl/libusb-compat
        ln -s /pool/ftp/ /pool/dl/libvorbis
        ln -s /pool/ftp/ /pool/dl/libvpx
        ln -s /pool/ftp/ /pool/dl/libwebsockets
        ln -s /pool/ftp/ /pool/dl/libxcb
        ln -s /pool/ftp/ /pool/dl/libxcrypt
        ln -s /pool/ftp/ /pool/dl/libxkbcommon
        ln -s /pool/ftp/ /pool/dl/libxml2
        ln -s /pool/ftp/ /pool/dl/libxslt
        ln -s /pool/ftp/ /pool/dl/libyaml
        ln -s /pool/ftp/ /pool/dl/libzip
        ln -s /pool/ftp/ /pool/dl/libzlib
        ln -s /pool/ftp/ /pool/dl/linux
        ln -s /pool/ftp/ /pool/dl/linuxconsoletools
        ln -s /pool/ftp/ /pool/dl/lirc-tools
        ln -s /pool/ftp/ /pool/dl/llvm
        ln -s /pool/ftp/ /pool/dl/llvm-cmake
        ln -s /pool/ftp/ /pool/dl/lz4
        ln -s /pool/ftp/ /pool/dl/lzip
        ln -s /pool/ftp/ /pool/dl/lzo
        ln -s /pool/ftp/ /pool/dl/m4
        ln -s /pool/ftp/ /pool/dl/mariadb
        ln -s /pool/ftp/ /pool/dl/mesa3d
        ln -s /pool/ftp/ /pool/dl/meson
        ln -s /pool/ftp/ /pool/dl/mpc
        ln -s /pool/ftp/ /pool/dl/mpfr
        ln -s /pool/ftp/ /pool/dl/mtdev
        ln -s /pool/ftp/ /pool/dl/nasm
        ln -s /pool/ftp/ /pool/dl/ncurses
        ln -s /pool/ftp/ /pool/dl/nettle
        ln -s /pool/ftp/ /pool/dl/nfs-utils
        ln -s /pool/ftp/ /pool/dl/ninja
        ln -s /pool/ftp/ /pool/dl/ntp
        ln -s /pool/ftp/ /pool/dl/opus
        ln -s /pool/ftp/ /pool/dl/pcre
        ln -s /pool/ftp/ /pool/dl/pcre2
        ln -s /pool/ftp/ /pool/dl/perl
        ln -s /pool/ftp/ /pool/dl/perl-parse-yapp
        ln -s /pool/ftp/ /pool/dl/pixman
        ln -s /pool/ftp/ /pool/dl/pkgconf
        ln -s /pool/ftp/ /pool/dl/popt
        ln -s /pool/ftp/ /pool/dl/procps-ng
        ln -s /pool/ftp/ /pool/dl/pugixml
        ln -s /pool/ftp/ /pool/dl/pulseaudio
        ln -s /pool/ftp/ /pool/dl/python3
        ln -s /pool/ftp/ /pool/dl/python-cython
        ln -s /pool/ftp/ /pool/dl/python-distlib
        ln -s /pool/ftp/ /pool/dl/python-flit-core
        ln -s /pool/ftp/ /pool/dl/python-glslang
        ln -s /pool/ftp/ /pool/dl/python-gobject
        ln -s /pool/ftp/ /pool/dl/python-installer
        ln -s /pool/ftp/ /pool/dl/python-mako
        ln -s /pool/ftp/ /pool/dl/python-markupsafe
        ln -s /pool/ftp/ /pool/dl/python-packaging
        ln -s /pool/ftp/ /pool/dl/python-pycryptodomex
        ln -s /pool/ftp/ /pool/dl/python-pypa-build
        ln -s /pool/ftp/ /pool/dl/python-pyproject-hooks
        ln -s /pool/ftp/ /pool/dl/python-pyyaml
        ln -s /pool/ftp/ /pool/dl/python-setuptools
        ln -s /pool/ftp/ /pool/dl/python-wheel
        ln -s /pool/ftp/ /pool/dl/qemu
        ln -s /pool/ftp/ /pool/dl/rapidjson
        ln -s /pool/ftp/ /pool/dl/readline
        ln -s /pool/ftp/ /pool/dl/samba4
        ln -s /pool/ftp/ /pool/dl/sbc
        ln -s /pool/ftp/ /pool/dl/sdl
        ln -s /pool/ftp/ /pool/dl/sdl2
        ln -s /pool/ftp/ /pool/dl/slirp
        ln -s /pool/ftp/ /pool/dl/spdlog
        ln -s /pool/ftp/ /pool/dl/speexdsp
        ln -s /pool/ftp/ /pool/dl/sqlite
        ln -s /pool/ftp/ /pool/dl/squashfs
        ln -s /pool/ftp/ /pool/dl/swig
        ln -s /pool/ftp/ /pool/dl/sysvinit
        ln -s /pool/ftp/ /pool/dl/taglib
        ln -s /pool/ftp/ /pool/dl/tar
        ln -s /pool/ftp/ /pool/dl/tcl
        ln -s /pool/ftp/ /pool/dl/tinyxml
        ln -s /pool/ftp/ /pool/dl/tinyxml2
        ln -s /pool/ftp/ /pool/dl/unzip
        ln -s /pool/ftp/ /pool/dl/usbutils
        ln -s /pool/ftp/ /pool/dl/util-linux
        ln -s /pool/ftp/ /pool/dl/vim
        ln -s /pool/ftp/ /pool/dl/vulkan-headers
        ln -s /pool/ftp/ /pool/dl/wayland
        ln -s /pool/ftp/ /pool/dl/waylandpp
        ln -s /pool/ftp/ /pool/dl/wayland-protocols
        ln -s /pool/ftp/ /pool/dl/wget
        ln -s /pool/ftp/ /pool/dl/x265
        ln -s /pool/ftp/ /pool/dl/xcb-proto
        ln -s /pool/ftp/ /pool/dl/xlib_libICE
        ln -s /pool/ftp/ /pool/dl/xlib_libSM
        ln -s /pool/ftp/ /pool/dl/xlib_libX11
        ln -s /pool/ftp/ /pool/dl/xlib_libXau
        ln -s /pool/ftp/ /pool/dl/xlib_libXdamage
        ln -s /pool/ftp/ /pool/dl/xlib_libXdmcp
        ln -s /pool/ftp/ /pool/dl/xlib_libXext
        ln -s /pool/ftp/ /pool/dl/xlib_libXfixes
        ln -s /pool/ftp/ /pool/dl/xlib_libXi
        ln -s /pool/ftp/ /pool/dl/xlib_libXmu
        ln -s /pool/ftp/ /pool/dl/xlib_libXrandr
        ln -s /pool/ftp/ /pool/dl/xlib_libXrender
        ln -s /pool/ftp/ /pool/dl/xlib_libXScrnSaver
        ln -s /pool/ftp/ /pool/dl/xlib_libxshmfence
        ln -s /pool/ftp/ /pool/dl/xlib_libXt
        ln -s /pool/ftp/ /pool/dl/xlib_libXxf86vm
        ln -s /pool/ftp/ /pool/dl/xlib_xtrans
        ln -s /pool/ftp/ /pool/dl/xmlstarlet
        ln -s /pool/ftp/ /pool/dl/xorgproto
        ln -s /pool/ftp/ /pool/dl/xutil_util-macros
        ln -s /pool/ftp/ /pool/dl/xz
        ln -s /pool/ftp/ /pool/dl/zstd
    # Export zpool
    - run: |
        zfs get all dl
        sudo zpool export dl
        sudo qemu-nbd --disconnect /dev/nbd0
    - uses: actions/upload-artifact@v4
      with:
        name: dl-${{ inputs.tag }}-${{ inputs.arch }}.zpool.qcow2
        path: ${{ runner.temp }}/dl-${{ inputs.tag }}-${{ inputs.arch }}.zpool.qcow2
        compression-level: 0
  host:
    runs-on: ubuntu-latest
    steps:
    # Install dependencies
    - run: |
        sudo apt update
        sudo apt install --yes zfsutils-linux qemu-utils
    - run: |
        set -x
        sudo modprobe nbd nbds_max=1
        qemu-img create -f qcow2 "${{ runner.temp }}/host-${{ inputs.tag }}-${{ inputs.arch }}.zpool.qcow2" 64G
        sudo qemu-nbd --connect /dev/nbd0 --format qcow2 "${{ runner.temp }}/host-${{ inputs.tag }}-${{ inputs.arch }}.zpool.qcow2"
        sudo zpool create -O compression=zstd -m /pool/host host /dev/nbd0
        sudo chown "$USER:$USER" /pool/host/
    # Export zpool
    - run: |
        zfs get all host
        sudo zpool export host
        sudo qemu-nbd --disconnect /dev/nbd0
    - uses: actions/upload-artifact@v4
      with:
        name: host-${{ inputs.tag }}-${{ inputs.arch }}.zpool.qcow2
        path: ${{ runner.temp }}/host-${{ inputs.tag }}-${{ inputs.arch }}.zpool.qcow2
        compression-level: 0
  output:
    runs-on: ubuntu-latest
    steps:
    # Install dependencies
    - run: |
        sudo apt update
        sudo apt install --yes zfsutils-linux qemu-utils
    - run: |
        set -x
        sudo modprobe nbd nbds_max=1
        qemu-img create -f qcow2 "${{ runner.temp }}/output-${{ inputs.tag }}-${{ inputs.arch }}.zpool.qcow2" 64G
        sudo qemu-nbd --connect /dev/nbd0 --format qcow2 "${{ runner.temp }}/output-${{ inputs.tag }}-${{ inputs.arch }}.zpool.qcow2"
        sudo zpool create -O compression=zstd -m /pool/output output /dev/nbd0
        sudo chown "$USER:$USER" /pool/output/
        mkdir --parents /pool/output/build/.npm
    # Export zpool
    - run: |
        zfs get all output
        sudo zpool export output
        sudo qemu-nbd --disconnect /dev/nbd0
    - uses: actions/upload-artifact@v4
      with:
        name: output-${{ inputs.tag }}-${{ inputs.arch }}.zpool.qcow2
        path: ${{ runner.temp }}/output-${{ inputs.tag }}-${{ inputs.arch }}.zpool.qcow2
        compression-level: 0
