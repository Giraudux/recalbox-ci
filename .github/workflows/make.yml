name: make

on:
  workflow_call:
    inputs:
      tag:
        required: true
        type: string
      arch:
        required: true
        type: string
      timeout:
        type: number
        default: 14400 # 4 hours
      build_extra_args:
        type: string
        default: ""
      ccache:
        type: boolean
        default: true
      ccache_size:
        type: number
        default: 8
      release:
        default: false
        type: boolean
    outputs:
      status:
        value: ${{ jobs.build.outputs.status }}

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.build.outputs.status }}
    steps:
    - name: "Install dependencies"
      run: |
        sudo apt update
        sudo apt install --yes ccache zfsutils-linux
    - name: "Free disk space"
      uses: endersonmenezes/free-disk-space@v3
      with:
        remove_android: true
        remove_dotnet: true
        remove_haskell: true
        remove_tool_cache: true
        remove_swap: true
        remove_packages: "azure-cli google-cloud-cli microsoft-edge-stable google-chrome-stable firefox postgresql* temurin-* *llvm* mysql* dotnet-sdk-*"
        remove_packages_one_command: true
        remove_folders: "/usr/share/swift /usr/share/miniconda /usr/share/az* /usr/local/lib/node_modules /usr/local/share/chromium /usr/local/share/powershell /usr/local/julia /usr/local/aws-cli /usr/local/aws-sam-cli /usr/share/gradle"
        rm_cmd: "rmz"
        rmz_version: "3.1.1"
        testing: false
    - name: "Create ZFS"
      run: |
        set -x
        readonly device=/dev/$(lsblk --noheadings --output PKNAME "$(findmnt --noheadings --output SOURCE /mnt/)")
        sudo umount /mnt/
        sudo zpool create -O compression=zstd mnt "$device"
        sudo chown "$USER:$USER" /mnt/
    - name: "Download output"
      id: download-output
      continue-on-error: true
      uses: actions/download-artifact@v5
      with:
        name: recalbox-${{ inputs.arch }}-output
    - name: "Extract output"
      if: steps.download-output.outcome == 'success'
      run: |
        tar -xf "recalbox-${{ inputs.arch }}-output.tar.zst" -C /mnt/
        rm "recalbox-${{ inputs.arch }}-output.tar.zst"
    - name: "Create output"
      if: steps.download-output.outcome != 'success'
      run: |
        mkdir -p /mnt/output/build/.npm/
    - name: "Download source"
      uses: actions/download-artifact@v5
      with:
        name: recalbox-${{ inputs.tag }}-source
    - name: "Extract source"
      run: |
        tar -xf "recalbox-${{ inputs.tag }}-source.tar.zst"
        rm "recalbox-${{ inputs.tag }}-source.tar.zst"
    - name: "Download Docker image"
      uses: actions/download-artifact@v5
      with:
        name: recalbox-${{ inputs.tag }}-docker-image
    - name: "Load Docker image"
      run: |
        zstdcat "recalbox-${{ inputs.tag }}-docker-image.tar.zst" | docker load
        rm "recalbox-${{ inputs.tag }}-docker-image.tar.zst"
    - name: "Download ccache"
      if: inputs.ccache
      id: download-ccache
      continue-on-error: true
      uses: actions/download-artifact@v5
      with:
        name: recalbox-${{ inputs.arch }}-ccache
    - name: "Extract & cleanup ccache"
      if: inputs.ccache && steps.download-ccache.outcome == 'success'
      run: |
        tar -xf "recalbox-${{ inputs.arch }}-ccache.tar.zst"
        rm "recalbox-${{ inputs.arch }}-ccache.tar.zst"
        CCACHE_DIR="${{ github.workspace }}/ccache" ccache -M "${{ inputs.ccache_size }}G" --cleanup
    - name: "Create ccache"
      if: inputs.ccache && steps.download-ccache.outcome != 'success'
      run: |
        mkdir ccache/
        CCACHE_DIR="${{ github.workspace }}/ccache" ccache -M "${{ inputs.ccache_size }}G"
    - name: "Create dl"
      run: |
        mkdir dl/
    - name: "Debug"
      if: always()
      continue-on-error: true
      run: |
        set -x +e
        ls -l
        df -h
        du -hs ccache/ dl/ recalbox/ /mnt/output/
        CCACHE_DIR="${{ github.workspace }}/ccache" ccache -s
    - name: "Build"
      id: build
      run: |
        set -x
        readonly timeout_sec="${{ inputs.timeout }}"
        current_time_sec=$(date +%s)
        end_time_sec=$((current_time_sec + timeout_sec))
        (sleep "$timeout_sec" ; docker exec --user root recalbox sh -c "chmod -x /usr/bin/make") &
        if docker run --rm --security-opt seccomp=unconfined \
          --name recalbox \
          --volume "${{ github.workspace }}/recalbox/:/work/" \
          --volume "/mnt/output/:/work/output/" \
          --volume "/mnt/output/build/.npm/:/.npm/" \
          --volume "${{ github.workspace }}/dl/:/share/dl/" \
          --volume "${{ github.workspace }}/ccache/:/share/ccache" \
          --env "ARCH=${{ inputs.arch }}" \
          --env "RECALBOX_VERSION=${{ inputs.tag }}" \
          --env "FORCE_UNSAFE_CONFIGURE=1" \
          --env "PACKAGE=BR2_BACKUP_SITE=\"${{ secrets.BR2_BACKUP_SITE }}\" ${{ inputs.build_extra_args }}" \
          --env "RECALBOX_CCACHE_ENABLED=${{ inputs.ccache && 'y' || '' }}" \
          --env "RECALBOX_CCACHE_MAX_SIZE=${{ inputs.ccache_size }}G" \
          --user "$(id --user):$(id --group)" \
          recalbox
        then
          echo "status=success" >> "$GITHUB_OUTPUT"
        else
          current_time_sec=$(date +%s)
          if [ "$current_time_sec" -lt "$end_time_sec" ]
          then
            echo "status=failure" >> "$GITHUB_OUTPUT"
            exit 1
          else
            echo "status=continue" >> "$GITHUB_OUTPUT"
          fi
        fi
    - name: "Debug"
      if: always()
      continue-on-error: true
      run: |
        set -x +e
        ls -l
        df -h
        du -hs ccache/ dl/ recalbox/ /mnt/output/
        CCACHE_DIR="${{ github.workspace }}/ccache" ccache -s
    - name: "Upload images"
      if: steps.build.outputs.status == 'success'
      uses: actions/upload-artifact@v4
      with:
        name: recalbox-${{ inputs.tag }}-${{ inputs.arch }}-images
        path: /mnt/output/images/
        compression-level: 0
    - name: "Upload release"
      if: steps.build.outputs.status == 'success' && inputs.release
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh release upload "${{ inputs.tag }}" /mnt/output/images/*
    - name: "Clear source"
      run: |
        rm -rf recalbox/
    - name: "Compress ccache"
      run: |
        tar --remove-files -caf recalbox-${{ inputs.arch }}-ccache.tar.zst ccache/
    - name: "Upload ccache"
      uses: actions/upload-artifact@v4
      with:
        name: recalbox-${{ inputs.arch }}-ccache
        path: recalbox-${{ inputs.arch }}-ccache.tar.zst
        compression-level: 0
        overwrite: true
    - name: "Clear cache"
      if: inputs.ccache
      run: |
        rm -rf ccache/ recalbox-${{ inputs.arch }}-ccache.tar.zst
    - name: "Prepare dl"
      run: |
        find dl/ -mindepth 2 -maxdepth 2 -type d -exec rm -rf "{}" \;
    - name: "Upload dl"
      uses: actions/upload-artifact@v4
      with:
        name: recalbox-${{ inputs.arch }}-dl
        path: dl/
        compression-level: 0
        overwrite: true
    - name: "Clear dl"
      run: |
        rm -rf dl/
    - name: "Compress output"
      run: |
        tar -caf recalbox-${{ inputs.arch }}-output.tar.zst -C /mnt/ output/
    - name: "Upload output"
      uses: actions/upload-artifact@v4
      with:
        name: recalbox-${{ inputs.arch }}-output
        path: recalbox-${{ inputs.arch }}-output.tar.zst
        compression-level: 0
        overwrite: true
